---
title: "Provincial Groundwater Observation Well Network (PGOWN) summary"
output: html_document
---
<!--
Copyright 2019 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->

Provincial Groundwater Observation Well Network (PGOWN) summary, by FLNRO boundaries, of the % of wells with water level data that has not been validated within the past 7 months and the average age (months) since the water level data has been validated. The target is validated data no greater than 7 months of age.

```{r include = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)

```


```{r setup, include=FALSE}

## Load libraries
library(readr) #load data from BC Data Catalogue
library(readxl) #load xlsx files
library(dplyr) # data munging
library(envreportutils)
library(tidyr)
library(stringr)
library(lubridate)
library(gridExtra)


#wfile <- file.path("process-groundwater-reporting-data/data",
#                   "MASTER_Metrics for Publicly Available PGOWN Validated #Data.xlsx")


#wfile <- file.path("data",
#                   "MASTER_Metrics for Publicly Available PGOWN Validated Data.xlsx")

wfile <- file.path(
  soe_path("Operations ORCS/Special Projects/Water Program/Groundwater Wells Reporting/Data"),
  "MASTER_Metrics for Publicly Available PGOWN Validated Data.xlsx"
)

```

```{r, echo = FALSE, interval= FALSE, warning = FALSE, results = "hide"}

# format the most recent dataset 

wdata <- read_excel(wfile, sheet = "Feb 2019", range = "A2:J228",
                    col_names = c("Region", "Data_graded", "Well_ID", "Location",
                                  "Date_Validated", "Months_since_val", "foo","initial_cost","foo1", "comment"),
                    col_types = c("text", "text", "text","text", "date", "text",
                                  "text", "text", "text","text")) %>%
  select(-c("foo", "foo1")) %>%
  mutate(Region = ifelse(str_detect(Region, "%"),NA ,Region),
         Region = ifelse(str_detect(Region, "Total"),NA ,Region), 
         initial_cost = as.numeric(initial_cost)) %>%
  fill(Region) %>%
  filter_at(.vars = vars(Data_graded, Well_ID), .vars_predicate = any_vars(!is.na(.)))

# format dates calculate months since specified data. This currently calculates for three dates: 
# today, Feb 2019 and July 2020.

wdata <- wdata %>%
  mutate(dateCheckToday = round(interval(ymd(wdata$Date_Validated),
                                         ymd(Sys.Date()))/ months(1), 0),
         dateCheckFeb19 = round(interval(ymd(wdata$Date_Validated),
                                         ymd("2019-02-01"))/ months(1), 0),
         dateCheckJuly20 = round(interval(ymd(wdata$Date_Validated),
                                          ymd("2020-07-01"))/ months(1), 0))

# calculate the summary stats per region -----------------------------

# finacial start up cost
well.cost <- wdata %>%
  group_by(Region) %>% 
  summarise(invest_cost = sum(initial_cost, na.rm = TRUE))

# number of active wells and graded / not graded

well.stats <- wdata %>% 
  group_by(Region) %>%
  count(Data_graded) %>%
  filter(!is.na(Data_graded)) %>%
  mutate(Data_graded = ifelse(Data_graded == "-", "Well_inactive", 
                              ifelse(Data_graded == "N", "Wells_nograde", 
                                     ifelse(Data_graded == "Y", "Wells_yesgrade", Data_graded)))) %>%
  spread(., key = Data_graded, value = n,fill = 0) %>%
  mutate(Wells_ActiveTotal = sum( Wells_nograde,Wells_yesgrade))

well.stats <- left_join(well.stats, well.cost)

# percent of wells not validate in the last seven months (currently using Feb 2019 date)
well.time.stats <- wdata %>% 
  group_by(Region) %>%
  summarise(n_gt7 = sum(dateCheckFeb19 > 7, na.rm = TRUE),
            m_ave = mean(dateCheckFeb19 , na.rm = TRUE), 
            m_total = sum(dateCheckFeb19, na.rm = TRUE))  
 
well.stats <- left_join(well.stats, well.time.stats) 

well.stats <- well.stats %>%
  mutate (perc_gt7m =(n_gt7 / Wells_ActiveTotal) * 100 , 
          per_grad= (Wells_yesgrade / Wells_ActiveTotal) * 100)
        
well.stats$Region = factor(well.stats$Region, ordered = TRUE, levels = c("Skeena", "Ominca/Peace", "Okanagan/Kootenay","Cariboo/Thompson", "Lower Mainland",  "Vancouver Island"))


#write.csv(well.stats, file.path("process-groundwater-reporting-data/output/", "test.csv"))

# format table 
well.table <- well.stats %>%
  select(c(Region, Wells_ActiveTotal, perc_gt7m, m_ave )) %>%
  rename(Region = Region, 
         `Total Active Wells` = Wells_ActiveTotal, 
         `% of well >7m` = perc_gt7m, 
         `Average age (months)` = m_ave) %>%
  mutate(`% of well >7m` = round(`% of well >7m`,1) , 
         `Average age (months)` = round(`Average age (months)`,1))


well.table <- well.table %>%
  arrange(Region)

```

```{r, include = TRUE, echo= FALSE}
knitr::kable(well.table)
```


```{r plots, include = FALSE, warning = FALSE}
# make a pretty plot 
library(ggplot2) 
  
# percent of wells validated within the prvious 7 months 
# note inverted number 
p1 <- ggplot(well.stats, aes(Region, 100 - perc_gt7m)) + 
  geom_bar(stat = "identity") + 
  coord_flip() + 
  ylim(0,100) + 
  labs(title = "Percentage of Wells validated within the previous 7 months", 
       x = "", y = "Percentage of active wells")

  
p2 <-ggplot(well.stats, aes(Region, m_ave)) + 
  geom_bar(stat = "identity") + 
  coord_flip() + 
  geom_text(aes(label= round(m_ave, 1), hjust = -1))+ 
  ylim(0, max(well.stats$m_ave + 0.1*max(well.stats$m_ave))) + 
  labs(title = "Average time since validation ", 
       x = "", y = "month") + 
  geom_hline(yintercept=7, linetype="dashed", color = "red")


```

```{r, echo = FALSE}
library(gridExtra)
grid.arrange(p1, p2, ncol=2)

```

```{r, set-upmap, echo = FALSE, results = "hide"}

library(bcmaps)
library(bcdata)
library(sf)

# read in the mapping base data	
regions <- 	bcdc_get_data("fefa94a1-d959-46c4-9d29-bf144ca736e8") %>%
   st_transform(4326) %>%
  select(REGION_NAME) %>%
  mutate(REGION_NAME = ifelse(REGION_NAME %in% c("Okanagan","Kootenay"),
                              "Okanagan/Kootenay", 
                              ifelse(REGION_NAME %in% c("Omineca", "Peace"),
                                     "Ominca/Peace", 
                                     ifelse(REGION_NAME %in% c("Cariboo", "Thompson"), "Cariboo/Thompson", REGION_NAME))), 
         Region = REGION_NAME) 

regions <- regions %>% left_join(well.stats)

```

Click on the maps below to explore the trends across the province.

# {.tabset .tabset-fade}

##  Interactive map 
```{r, echo = FALSE}
library(leaflet)

labs <- dplyr::select(regions, Region, Wells_ActiveTotal,invest_cost, per_grad)
st_geometry(labs) <- NULL

lab1 <- lapply(seq(nrow(labs)), function(i) {
  paste0( '<b>', labs[i, "Region"], ', ',  
          labs[i, "invest_cost"], '</b>') 
})

palette1 <- colorFactor(palette = 'viridis', regions$Wells_ActiveTotal, reverse = TRUE)


watermap <- leaflet(width = "900px", height = "600px", 
                    options = leafletOptions(minZoom = 5)) %>%  
  addProviderTiles(providers$Stamen.Terrain, group = "Terrain") %>%
  add_bc_home_button() %>%
  set_bc_view()

watermap %>% 
  addPolygons(data = regions, group = "Conservation Status",
              stroke = T, weight = 1, color = "black", # Add border to polygons
              fillOpacity = 0.5, # Polygon fill
              fillColor = ~palette1(regions$Wells_ActiveTotal),
              label = lapply(lab1, htmltools::HTML),
              labelOptions = labelOptions(direction = "auto", textsize = "12px"),
              #popup = constatus_popup,
              #popupOptions = popupOptions(maxWidth = 300, minWidth = 300, 
               #                           maxHeight = 300,
              #                            autoPan = TRUE,
              #                            keepInView = TRUE,
              #                            closeOnClick = TRUE,
              #                            autoPanPaddingTopLeft = c(120, 20),
              #                            autoPanPaddingBottomRight = c(150,20)),
              highlightOptions = highlightOptions( # Highlight interaction for mouse hover
                weight = 3,
                color = "yellow",
                bringToFront = T)) %>%
  addLegend("bottomright", pal = palette1, values = regions$Wells_ActiveTotal,
            title = "Active Wells", na.label = "Extirpated",
            opacity = 1) 


```

## Static Map 

```{r,  map, echo = FALSE, results = "hide"}

# Map 1: concervation concern
rmap <- ggplot(regions) +
  geom_sf(data = bc_bound(), fill = NA, color = "grey", size = 0.2) +
  geom_sf(aes(fill = Region), alpha = 0.8) +
  coord_sf(datum = NA) + 
#  labs(fill = "Regions") +
  theme_minimal() +
  theme(legend.position = c(0.1, 0.35))

```


```{r, echo = FALSE}
rmap
```


## Caveats 

*This assessment was completed February 4 and 5, 2019 and is current as of this date.

### Method: 
All active PGOWN wells publicly available on the [PGOWN Interactive Map](https://governmentofbc.maps.arcgis.com/apps/webappviewer/index.html?id=b53cb0bf3f6848e79d66ffd09b74f00d) are assessed on a region-by-region basis. The water level data is downloaded for each well and the last month that the data is categorized as validated, is noted. For each region, the % of wells in that region with validated data greater than 7 months old is determined. For each region, the average age of data is determined based on the number of wells displayed on the interactive map at the time of the snapshot and the total age (in months) of the validated data.

*The number of active wells displayed on the interactive map may change from year to year as wells are added / removed from PGOWN (i.e. it is not static)

*This review checks the frequency of publicly available data validation, quality of systems operations (Aquarius Database / PGOWN Interactive Map) and communications, frequency of site visits, and overall efficiency of network protocols that have been implemented. This review and report can be used as one of several metrics for overall workload of PGOWN staff.

*Sites may show as ‘active’ on the map when they are inactive (no longer collecting data), new monitoring sites collecting data may not be displayed on the map at the time of the snapshot assessment.

*The focus of this ‘snapshot’ is on publicly available validated groundwater level data. The monitoring sites equipped with properly working satellite telemetry equipment should still be transmitting near real time unvalidated data.


